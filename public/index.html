<html>  
  <head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  </head>

  <script type="text/javascript">

    var players = []
 
    var myID = -1
    var socket = undefined;
    var roundCount = 0
    var busTickets = -1
    var metroTickets = -1
    var taxiTickets = -1
    var myPosition = -1
    var amIMrX = false
    var playersPositions = {}
    var playerImages = []   
    var selectedPosStep = -1

    function onPageLoad() {
        document.getElementById("messageBox").value = "";
    }
    function connectWs() {

        socket = new WebSocket('ws://localhost:8080/?roomid='+document.getElementById("roomIdInput").value);
        socket.addEventListener('open', (event) => {console.log("Connected.")});
        socket.addEventListener('message', (event) => { //You can parse messages and control the game here.
          
          var s = JSON.parse(event.data)
          if(s.type=="STATE_UPDATE"){
            
      
            for (let i=0;i<s.data.length;i++){
              var ty = 'player' + (i)

            if(!players.includes(s.data[i].id)){
            players.push([s.data[i].id])}

            if(!players.includes(s.data[i].color)){
            playerImages.push(s.data[i].color + ".png")}
              console.log(players)
              console.log(playerImages)
              console.log(playersPositions)
            document.getElementById(ty).src = s.data[i].color + ".png"
            
            playersPositions[s.data[i].id] = (s.data[i].position)
            console.log(playersPositions)
            
            if (i == myID ){
              busTickets = s.data[i].tickets.bus
              metroTickets = s.data[i].tickets.metro
              taxiTickets = s.data[i].tickets.taxi

            }
           
          }
         
          drawMap()
          }

          if(s.type=="OWN_DATA_UPDATE"){
            myPosition = s.data.position
            playersPositions[myID] = myPosition
            busTickets = s.data.tickets.bus
            metroTickets = s.data.tickets.metro
            taxiTickets = s.data.tickets.taxi
            drawMap()
          }
          
          
          if(s.type=="NEXT_ROUND"){
              roundCount +=1
            }


       
          if(s.type=="MR_X_LAST_TICKET"){

              addMrXRoute(s.ticket,roundCount)
            }
              
          if(s.type=="log"){
            myid_ = s.msg.split(":")
            myID = myid_[1].trim()
          }
          if(s.type=="YOU_ARE_MR_X"){
            amIMrX = true
          }

        });
        socket.addEventListener('close', (event) => {console.log("Closed."); socket = undefined;});
    }
    function sendMsg(msgToSend) {
        if(socket!==undefined) {
            socket.send(msgToSend);
        }
        else {
            alert("There is no alive connection.");
        }
    }
    function sendCustom() {
        let msgToSend = document.getElementById("msgInput").value;
        sendMsg(msgToSend);
    }
    function becomeMrX() {
        sendMsg(`{"type" : "CLAIM_MR_X"}`);
    }
    function getOwnData() {
        socket.send(`{"type": "GET_OWN_DATA"}`);
    }
    function stepTo(pos,veh) {
        socket.send(`{"type": "step", "toPos":${pos}, "byVehicle": "${veh}"}`);
        getOwnData()

    }

    function addMrXRoute(mode,round){
      document.getElementById("round" + round).textContent = mode
    }
//semmi


var testmessage = "?"
</script>
<body>
  <div style="margin-top:50px">
    <input type="text" style="margin-left: 100px; " id="roomIdInput" placeholder="Szoba azonositó" /> 
    <input type="button"  style="margin-left: 10px;" onclick="connectWs()" value="Belépés"/> <br>
  </div>    <div style="text-align: center; font-family: Raleway, sans-serif; font-size: xx-large; color:white"> Scotland Yard </div>


<textarea id="messageBox" rows="20" cols="50" disabled style="display:none"></textarea><br>

    <div style="float:right; color:white; margin-right: 100px">
        Eszköz választása:
        <button onclick="selectBus()">
            Busz
        </button>
        <button onclick="selectTaxi()">
            Taxi
        </button>
        <button onclick="selectMetro()">
            Metró
        </button><br>
        
    </div>
    <button style="margin-left: 100px; margin-bottom:30px" onclick="becomeMrX()">Mr. X szeretnék lenni!</button><br>
    <span style="color: white; margin-left: 100px; margin-top:30px">Kiválasztott eszköz: </span>
    <span id="selected" style="color:white"></span>
    <div class="wrapper">
        
        <div style="width:1512px"><canvas style="margin-left: 100px; margin-top: 20; margin-bottom:90px" id="myCanvas" width="1512" height="779">
        </canvas></div>
        
        <div style="margin-top:20px; margin-left:0px;color: white;">Jegyek
            <table class="tg" style="margin-top:10px">
            <thead>
              <tr>
                
                <th class="tg-7btt" style="color: white;">Busz</th>
                <th class="tg-7btt" style="color: white;">Metró</th>
                <th class="tg-7btt" style="color: white;">Taxi</th>
              </tr>
            </thead>
            <tbody>
              <tr>
               
                <td class="tg-c3ow" style="color: white;" id="busTickets"></td>
                <td class="tg-c3ow" style="color: white;" id="metroTickets"></td>
                <td class="tg-c3ow" style="color: white;" id="taxiTickets"></td>
              </tr>
            </tbody>
            </table>
            <br /><br />
<div style="margin-top:20px; color: white;">Utazási napló
    <table class="tg" style="margin-top:30px">
    <thead>
      <tr>
        
        <th class="tg-7btt">Kör</th>
        <th class="tg-7btt">Utazási mód</th>

      </tr>
    </thead>
    <tbody>
        <tr>
        
            <th class="tg-7btt">1</th>
            <th class="tg-7btt" id="round1"></th>
    
          </tr>

      <tr>
       
        <td class="tg-c3ow">2</td>
        <td class="tg-c3ow" id="round2"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">3</td>
        <td class="tg-c3ow" id="round3"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">4</td>
        <td class="tg-c3ow" id="round4"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">5</td>
        <td class="tg-c3ow" id="round5"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">6</td>
        <td class="tg-c3ow" id="round6"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">7</td>
        <td class="tg-c3ow" id="round7"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">8</td>
        <td class="tg-c3ow" id="round8"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">9</td>
        <td class="tg-c3ow" id="round9"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">10</td>
        <td class="tg-c3ow" id="round10"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">11</td>
        <td class="tg-c3ow" id="round11"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">12</td>
        <td class="tg-c3ow" id="round12"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">13</td>
        <td class="tg-c3ow" id="round13"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">14</td>
        <td class="tg-c3ow" id="round14"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">15</td>
        <td class="tg-c3ow" id="round15"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">16</td>
        <td class="tg-c3ow" id="round16"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">17</td>
        <td class="tg-c3ow" id="round17"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">18</td>
        <td class="tg-c3ow" id="round18"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">19</td>
        <td class="tg-c3ow" id="round19"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">20</td>
        <td class="tg-c3ow" id="round20"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">21</td>
        <td class="tg-c3ow"id="round21"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">22</td>
        <td class="tg-c3ow" id="round22"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">23</td>
        <td class="tg-c3ow" id="round23"></td>
      </tr>
      <tr>
       
        <td class="tg-c3ow">24</td>
        <td class="tg-c3ow" id="round24"></td>
      </tr>

    </tbody>
    </table></div>
</div>

</div>
<style>
    body{
        background-image: linear-gradient(to right, #00b4db, #0083b0);
        
        }
</style>



    <style type="text/css">
        .tg  {border-collapse:collapse;border-spacing:0; color:white; background-color: #665a5a;}
        .tg td{border-color:rgb(255, 255, 255);border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:10px; color:white;
          overflow:hidden;padding:5px 5px;word-break:normal;}
        .tg th{border-color:rgb(255, 255, 255);border-style:solid;border-width:1px;font-family:Arial, sans-serif;font-size:10px;
          font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
        .tg .tg-c3ow{border-color:inherit;text-align:center;vertical-align:top}
        .tg .tg-7btt{border-color:inherit;font-weight:bold;text-align:center;vertical-align:top}
        </style>


    <img id="img1" style="display: none;" onclick="window.open(this.src)">
    <img id="img2"style="display: none;">
    <img id="img3"style="display: none;">
    <img id="img4"style="display: none;">
    <img id="img5"style="display: none;">
    <img id="img6"style="display: none;">
    <img id="img7"style="display: none;">
    <img id="img8"style="display: none;">
    <img id="img9"style="display: none;">
    <img id="img10"style="display: none;">

    <img id="player0" style="display: none;">
    <img id="player1" style="display: none;">
    <img id="player2" style="display: none;">
    <img id="player3" style="display: none;">
    <img id="player4" style="display: none;">
    <img id="player5" style="display: none;">
    <img id="player6" style="display: none;">
    <img id="player7" style="display: none;">
    <img id="player8" style="display: none;">
    
    <style>
        .wrapper {
      display: flex;
    }
    
    .wrapper > div {
      flex: 1;
    }
        </style>
<script>


var Acanvas = document.createElement('canvas');
var playerCtx = Acanvas.getContext('2d');

function selectBus(){
    selectedMode = "bus"
    document.getElementById("selected").textContent="Busz"

}
function selectTaxi(){
    selectedMode = "taxi"
    document.getElementById("selected").textContent="Taxi"
}
function selectMetro(){
   selectedMode = "metro"
   document.getElementById("selected").textContent="Metró"

}

var selectedMode = "none"





var player = 0
const marginOffset= 100

const taxiMatrix = [
[false, true, true, false, false, true, false, true, false, true],
[true, true, true, false, false, true, false, true, false, true],
[false, true, false, false, false, true, false, true, false, true],
[false, false, false, false, false, false, false, false, false, false],
[false, false, false, false, false, false, false, false, false, false],
[true, true, true, false, false, false, false, true, false, true],
[false, false, false, false, false, false, false, false, false, false],
[true, true, true, false, false, true, false, false, false, true],
[false, false, false, false, false, false, false, false, false, false],
[true, true, true, false, false, true, false, true, false, false]

]


const metroMatrix = [
[false, false, false, false, false, false, false, false, false, false],
[false, false, true, false, true, false, true, true, false, false],
[false, true, false, false, true, false, true, true, false, false],
[false, false, false, false, false, false, false, false, false, false],
[false, true, true, false, false, false, true, true, false, false],
[false, false, false, false, false, false, false, false, false, false],
[false, false, false, false, false, false, false, false, false, false],
[false, true, true, false, true, false, false, true, false, false],
[false, false, false, false, false, false, false, false, false, false],
[false, false, false, false, false, false, false, false, false, false]
]


const busMatrix = [
[false, false, true, true, false, true, true, true, true, false],
[false, false, false, false, false, false, false, false, false, false],
[true, false, false, true, false, true, true, true, true, false],
[true, false, true, false, false, true, true, true, true, false],
[false, true, true, false, false, false, true, true, false, false],
[true, false, true, true, false, false, true, true, true, false],
[true, false, true, true, false, false, false, true, true, false],
[true, false, true, true, false, false, true, false, true, false],
[true, false, true, true, false, false, true, true, false, false],  
[false, false, false, false, false, false, false, false, false, false]
]


const graphPoints = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]


var graphPointPositions = [
[406,142], //Batthyany
[703,267], //Szabadsag
[469,428], //Lanchid
[782,401], //Gozsdu
[600,733], //Rudas
[1004,196], //Oktogon
[1096,317], //Instant
[1163,492], //Blaha
[1180,631], //Rákóczi
[959,747], //Kálvin
[1151,870], //Corvin
[1472,383], //Keleti
[1665,391], //Arena
[1439,51], //Paprika
[1244,182] //Allatorvos
]

for (let i=0; i<graphPointPositions.length; i++){
    graphPointPositions[i][0] = (Math.round(graphPointPositions[i][0]-255)*0.76734192756)
    graphPointPositions[i][1] = Math.round(graphPointPositions[i][1]*0.76734192756)
}

var graphPointLengths = []


const graphImages = [
"blaha.png", //*
"szabadsag.png", //*
"oktogon.png", //*
"rudas.png", //*
"nyugati.png", //*
"deak.png", //*
"corvin.png", //*
"pillango.png",
"nagyvarad.png",
"arena.png",
"fiume.png",
"instant.png",
"hb.png",
"batthyány.png",
"kálvin.png",
"rákóczi.png"
]   



var canvas = document.getElementById("myCanvas");
    var tmpCtx = canvas.getContext("2d");

const radius = 30

var background = new Image();
background.src = "miniature.png";
background.id="background"
background.style="display:none"
document.body.appendChild(background);

background.onload = function(){
  tmpCtx.drawImage(background,0,0);   

};


function drawLines(radius){
var taxiPlaces = []
var metroPlaces = []
var busPlaces = []
for (let i=0; i<10;i++){
    for (let j=0; j<10;j++){
        if(taxiMatrix[i][j] == true){
            tmpCtx.strokeStyle = "yellow";
            tmpCtx.beginPath()
            tmpCtx.moveTo(graphPointPositions[i][0], graphPointPositions[i][1]);
            
            tmpCtx.lineTo(graphPointPositions[j][0], graphPointPositions[j][1]);
            tmpCtx.closePath()
            tmpCtx.beginPath()
            tmpCtx.arc(graphPointPositions[j][0],graphPointPositions[j][1], radius+3, 0, Math.PI * 2, true);
            //tmpCtx.arc(graphPointPositions[j][0],graphPointPositions[j][1], radius+3, 0, Math.PI * 2, true);
            tmpCtx.stroke();
            tmpCtx.closePath()
          
            if (!taxiPlaces.includes(i)) {
                taxiPlaces.push(i);
            }
            if (!taxiPlaces.includes(j)) {
                taxiPlaces.push(j);
            }

        }        
}
}


for (let i=0; i<10;i++){
    for (let j=0; j<10;j++){
        if(metroMatrix[i][j] == true){
            tmpCtx.strokeStyle = "red";
            var offset = 3
            tmpCtx.beginPath()
            tmpCtx.moveTo(graphPointPositions[i][0], graphPointPositions[i][1]);
            
            tmpCtx.lineTo(graphPointPositions[j][0], graphPointPositions[j][1]);
            
            tmpCtx.closePath()
            tmpCtx.beginPath()
            if (taxiPlaces.includes(i)){
                offset += 3
            }
            tmpCtx.arc(graphPointPositions[j][0],graphPointPositions[j][1], radius+offset, 0, Math.PI * 2, true);
            //tmpCtx.arc(graphPointPositions[j][0],graphPointPositions[j][1], radius+offset, 0, Math.PI * 2, true);
            tmpCtx.stroke();
            tmpCtx.closePath()

            if (!metroPlaces.includes(i)) {
                metroPlaces.push(i);
            }
            if (!metroPlaces.includes(j)) {
                metroPlaces.push(j);
            }
        }        
}
}


for (let i=0; i<10;i++){
    for (let j=0; j<10;j++){
        if(busMatrix[i][j] == true){
            tmpCtx.strokeStyle = "blue";
            tmpCtx.beginPath()
            tmpCtx.moveTo(graphPointPositions[i][0], graphPointPositions[i][1]);
            
            tmpCtx.lineTo(graphPointPositions[j][0], graphPointPositions[j][1]);
            tmpCtx.closePath()
            tmpCtx.beginPath()



            var offset = 3 
            if (taxiPlaces.includes(j)){
                offset += 3
            }
            if (metroPlaces.includes(j)){
                offset += 3
            }
            tmpCtx.arc(graphPointPositions[j][0],graphPointPositions[j][1], radius+offset, 0, Math.PI * 2, true);

//          tmpCtx.arc(graphPointPositions[j][0],graphPointPositions[j][1], radius+offset, 0, Math.PI * 2, true);
            tmpCtx.stroke();
            tmpCtx.closePath()

            if (!busPlaces.includes(i)) {
                busPlaces.push(i);
            }
            if (!busPlaces.includes(j)) {
                busPlaces.push(j);
            }
        }    
        }        
}
}


function drawPoint(arr,radius,position,sorszam, hovalep){

  if(hovalep == -1) {
    hovalep = position
  }
  var t = 'player' + (sorszam)
  var index= position
  var thumbImg = document.getElementById(t)
  thumbImg.src = playerImages[sorszam]
  if(amIMrX==false){
   
    if(thumbImg.src.includes("white")){

    }
    else{
      thumbImg.onload = function() {
     tmpCtx.save();

        
      tmpCtx.drawImage(thumbImg, arr[index][0]-radius,arr[index][1]-radius, radius*2, radius*2);


        tmpCtx.strokeStyle = "black";
            tmpCtx.beginPath()
            tmpCtx.moveTo(arr[hovalep][0],arr[hovalep][1]);
            tmpCtx.lineTo(arr[hovalep][0],arr[hovalep][1]);
            tmpCtx.closePath()
            tmpCtx.beginPath()
            tmpCtx.arc(arr[hovalep][0],arr[hovalep][1], radius-5, 0, Math.PI * 2, true);
            tmpCtx.stroke();
            tmpCtx.closePath()

};
    }
  }
  else{
  
      thumbImg.onload = function() {
        tmpCtx.save();

        tmpCtx.drawImage(thumbImg, arr[index][0]-radius,arr[index][1]-radius, radius*2, radius*2);

        if(thumbImg.src.includes("white")){
          tmpCtx.strokeStyle = "black";
            tmpCtx.beginPath()
            tmpCtx.moveTo(arr[hovalep][0],arr[hovalep][1]);
            
            tmpCtx.lineTo(arr[hovalep][0],arr[hovalep][1]);
            tmpCtx.closePath()
            tmpCtx.beginPath()
            tmpCtx.arc(arr[hovalep][0],arr[hovalep][1], radius-5, 0, Math.PI * 2, true);
            tmpCtx.stroke();
            tmpCtx.closePath()
}
 
};
    
  }

}  


canvas.addEventListener('click', function(event) {var ind = -1

var x;
var y;
if (event.pageX || event.pageY) { 
  x = event.pageX;
  y = event.pageY;
}
else { 
  x = event.clientX + document.body.scrollLeft + document.documentElement.scrollLeft; 
  y = event.clientY + document.body.scrollTop + document.documentElement.scrollTop; 
} 
x -= canvas.offsetLeft;
y -= canvas.offsetTop;

for(let i=0;i<graphPointPositions.length;i++){

    if(x<graphPointPositions[i][0]+radius &&x>graphPointPositions[i][0]-radius){
    
        if(y<graphPointPositions[i][1]+radius &&y>graphPointPositions[i][1]-radius){
           
            ind = i
    }
    else{
        ind = -1
    }
}

} 
selectedPosStep = ind
stepTo(ind,selectedMode) //pos,veh

}, false);


function drawMap(){


//drawLines(radius);
tmpCtx.drawImage(background,0,0);   
for (let i=0; i<players.length;i++){
    drawPoint(graphPointPositions,30,playersPositions[i],i,selectedPosStep)
}
document.getElementById("busTickets").textContent = busTickets
document.getElementById("metroTickets").textContent = metroTickets
document.getElementById("taxiTickets").textContent = taxiTickets
}

</script>
</body>

</html>
